<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TecnariaBot</title>
  <!-- CSS ora preso da /static/img/style.css -->
  <link rel="stylesheet" href="/static/img/style.css" />
</head>
<body>
  <header class="container">
    <h1>TecnariaBot</h1>
    <p class="subtitle">Assistente Tecnico • Risposte A/B/C sempre coerenti</p>
  </header>

  <main class="container">
    <section class="panel">
      <label class="label">Domanda</label>
      <textarea id="q" rows="3" placeholder="Es. Quale altezza di connettore CTF devo usare in solaio con lamiera H55?..."></textarea>
    </section>

    <section class="grid">
      <!-- Card A -->
      <button class="card" data-mode="breve" id="cardA" aria-pressed="false">
        <div class="badge">A</div>
        <h3>Breve</h3>
        <p>Cliente finale / executive. 2-3 frasi, senza numeri.</p>
      </button>

      <!-- Card B -->
      <button class="card" data-mode="standard" id="cardB" aria-pressed="false">
        <div class="badge">B</div>
        <h3>Standard</h3>
        <p>Commerciale / progettuale base. Discorsiva, senza formule.</p>
      </button>

      <!-- Card C (default) -->
      <button class="card active" data-mode="dettagliata" id="cardC" aria-pressed="true">
        <div class="badge">C</div>
        <h3>Dettagliata</h3>
        <p>Tecnici/Ingegneri. Parametri, calcoli, verifica, conclusione unica.</p>
      </button>
    </section>

    <section class="panel">
      <label class="label">Contesto (facoltativo)</label>
      <input id="c" type="text" placeholder="Es. lamiera H55, V_L,Ed=150 kN/m, cls C30/37, passo gola 150 mm, lamiera trasversale">
    </section>

    <section class="actions">
      <button id="send" class="primary">Invia</button>
      <div class="hint">Scorciatoie: <kbd>A</kbd> Breve • <kbd>B</kbd> Standard • <kbd>C</kbd> Dettagliata • <kbd>Ctrl/⌘+Invio</kbd> Invia</div>
    </section>

    <section id="status" class="status" aria-live="polite"></section>

    <section class="panel">
      <div class="result-header">
        <span>Risposta</span>
        <button id="copy" class="ghost" title="Copia risposta">Copia</button>
      </div>
      <pre id="out" class="result" tabindex="0"></pre>
    </section>
  </main>

  <footer class="container footer">
    <small>© TecnariaBot • Modalità sempre allineate A/B/C</small>
  </footer>

  <script>
    const cards = document.querySelectorAll('.card');
    const out = document.getElementById('out');
    const statusEl = document.getElementById('status');
    const btnSend = document.getElementById('send');
    const btnCopy = document.getElementById('copy');
    const q = document.getElementById('q');
    const c = document.getElementById('c');

    let mode = 'dettagliata'; // default C

    function setMode(newMode){
      mode = newMode;
      cards.forEach(card => {
        const active = card.dataset.mode === newMode;
        card.classList.toggle('active', active);
        card.setAttribute('aria-pressed', active ? 'true' : 'false');
      });
    }

    cards.forEach(card => {
      card.addEventListener('click', () => setMode(card.dataset.mode));
    });

    async function send(){
      const question = q.value.trim();
      const context = c.value.trim();
      out.textContent = '';
      statusEl.textContent = '⏳ Sto preparando la risposta...';
      btnSend.disabled = true;

      try {
        const r = await fetch('/api/answer', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({question, mode, context})
        });
        const j = await r.json();
        if (!r.ok) throw new Error(j.error || r.statusText);
        out.textContent = (j.answer || '').trim();
        statusEl.textContent = `✅ Modalità: ${j.mode || mode}`;
      } catch (err){
        statusEl.textContent = '❌ Errore: ' + err.message;
      } finally {
        btnSend.disabled = false;
      }
    }

    btnSend.addEventListener('click', send);
    btnCopy.addEventListener('click', () => {
      if (!out.textContent) return;
      navigator.clipboard.writeText(out.textContent);
      statusEl.textContent = '📋 Copiato negli appunti';
    });

    // Scorciatoie tastiera
    document.addEventListener('keydown', (e) => {
      if (e.key.toLowerCase() === 'a') setMode('breve');
      if (e.key.toLowerCase() === 'b') setMode('standard');
      if (e.key.toLowerCase() === 'c') setMode('dettagliata');
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') send();
    });
  </script>
</body>
</html>
