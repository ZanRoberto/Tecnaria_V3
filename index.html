<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TecnariaBot</title>

  <!-- Icona scheda -->
  <link rel="icon" type="image/jpeg" href="/static/img/logo.jpg">
  <!-- Stili -->
  <link rel="stylesheet" href="/static/img/style.css" />
</head>
<body>
  <!-- HEADER con logo -->
  <header class="container header-logo">
    <img src="/static/img/logo.jpg" alt="Logo Tecnaria" class="logo" />
    <div>
      <h1>TecnariaBot</h1>
      <p class="subtitle">Assistente Tecnico • Risposte A/B/C sempre coerenti</p>
    </div>
  </header>

  <main class="container">
    <!-- DOMANDA -->
    <section class="panel">
      <label class="label" for="q">Domanda</label>
      <textarea id="q" rows="3" placeholder="Es. Quale altezza di connettore CTF devo usare in solaio con lamiera H55?..."></textarea>
    </section>

    <!-- SELEZIONE MODALITÀ -->
    <section class="grid" aria-label="Seleziona la modalità di risposta">
      <!-- Card A -->
      <button class="card" data-mode="breve" id="cardA" aria-pressed="false" type="button">
        <div class="badge">A</div>
        <h3>Breve</h3>
        <p>Cliente finale / executive. 2–3 frasi, senza numeri.</p>
      </button>

      <!-- Card B -->
      <button class="card" data-mode="standard" id="cardB" aria-pressed="false" type="button">
        <div class="badge">B</div>
        <h3>Standard</h3>
        <p>Commerciale / progettuale base. Discorsiva, senza formule.</p>
      </button>

      <!-- Card C (default) -->
      <button class="card active" data-mode="dettagliata" id="cardC" aria-pressed="true" type="button">
        <div class="badge">C</div>
        <h3>Dettagliata</h3>
        <p>Tecnici/Ingegneri. Parametri, calcoli, verifica, conclusione unica.</p>
      </button>
    </section>

    <!-- CONTESTO -->
    <section class="panel">
      <label class="label" for="c">Contesto (facoltativo)</label>
      <input id="c" type="text" placeholder="Es. lamiera H55, V_L,Ed=150 kN/m, cls C30/37, passo gola 150 mm, lamiera trasversale" />
    </section>

    <!-- AZIONI -->
    <section class="actions">
      <button id="send" class="primary" type="button">Invia</button>
      <div class="hint">Scorciatoie: <kbd>A</kbd> Breve • <kbd>B</kbd> Standard • <kbd>C</kbd> Dettagliata • <kbd>Ctrl/⌘+Invio</kbd> Invia</div>
    </section>

    <!-- STATO -->
    <section id="status" class="status" aria-live="polite"></section>

    <!-- RISPOSTA -->
    <section class="panel">
      <div class="result-header">
        <span>Risposta</span>
        <button id="copy" class="ghost" type="button" title="Copia risposta">Copia</button>
      </div>
      <pre id="out" class="result" tabindex="0"></pre>
    </section>

    <!-- ALLEGATI / NOTE TECNICHE -->
    <section class="panel">
      <div class="result-header">
        <span>Allegati / Note collegate</span>
      </div>
      <div id="attachments" class="attach-grid"></div>
    </section>
  </main>

  <footer class="container footer">
    <small>© TecnariaBot • Modalità sempre allineate A/B/C</small>
  </footer>

  <!-- SCRIPT -->
  <script>
    const cards = document.querySelectorAll('.card');
    const out = document.getElementById('out');
    const statusEl = document.getElementById('status');
    const btnSend = document.getElementById('send');
    const btnCopy = document.getElementById('copy');
    const q = document.getElementById('q');
    const c = document.getElementById('c');
    const attachmentsEl = document.getElementById('attachments');

    // Default: C (dettagliata)
    let mode = 'dettagliata';

    function setMode(newMode){
      mode = newMode;
      cards.forEach(card => {
        const active = card.dataset.mode === newMode;
        card.classList.toggle('active', active);
        card.setAttribute('aria-pressed', active ? 'true' : 'false');
      });
    }
    cards.forEach(card => card.addEventListener('click', () => setMode(card.dataset.mode)));

    // Estrae link sia markdown [testo](url) sia URL/percorsi nudi (http..., /static/...)
    function extractLinks(text){
      const links = new Set();

      // markdown [label](url) — supporta /static/... e http/https
      const md = [...text.matchAll(/\[[^\]]+\]\((https?:\/\/[^\s)]+|\/static\/[^\s)]+)\)/gi)];
      md.forEach(m => links.add(m[1]));

      // url/percorsi nudi
      const plain = [...text.matchAll(/((?:https?:\/\/|\/static\/)[^\s<>'"()]+(?:\([^\s<>'"]+\))?)/gi)];
      plain.forEach(m => links.add(m[1]));

      return [...links];
    }

    // Renderizza card allegati (immagini con anteprima, PDF con bottone)
    function renderAttachments(urls){
      attachmentsEl.innerHTML = '';
      if (!urls.length) return;

      urls.forEach(url => {
        const u = url.toLowerCase();
        if (u.endsWith('.png') || u.endsWith('.jpg') || u.endsWith('.jpeg') || u.endsWith('.webp')) {
          const a = document.createElement('a');
          a.href = url; a.target = '_blank'; a.rel = 'noopener';
          a.className = 'attach-card';
          a.innerHTML = `<img src="${url}" alt="allegato">`;
          attachmentsEl.appendChild(a);
        } else if (u.endsWith('.pdf')) {
          const a = document.createElement('a');
          a.href = url; a.target = '_blank'; a.rel = 'noopener';
          a.className = 'attach-card pdf';
          a.textContent = 'Apri PDF';
          attachmentsEl.appendChild(a);
        } else {
          const a = document.createElement('a');
          a.href = url; a.target = '_blank'; a.rel = 'noopener';
          a.className = 'attach-card link';
          a.textContent = url;
          attachmentsEl.appendChild(a);
        }
      });
    }

    async function send(){
      const question = q.value.trim();
      const context = c.value.trim();
      out.textContent = '';
      attachmentsEl.innerHTML = '';
      statusEl.textContent = '⏳ Sto preparando la risposta...';
      btnSend.disabled = true;

      try {
        const r = await fetch('/api/answer', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({question, mode, context})
        });
        const j = await r.json();
        if (!r.ok) throw new Error(j.error || r.statusText);

        const answer = (j.answer || '').trim();
        out.textContent = answer;

        // Estrai e mostra allegati
        const links = extractLinks(answer);
        renderAttachments(links);

        // Auto-open se c'è un solo allegato
        const AUTO_OPEN = true;
        if (AUTO_OPEN && links.length === 1) {
          window.open(links[0], '_blank', 'noopener');
        }

        statusEl.textContent = `✅ Modalità: ${j.mode || mode}`;
      } catch (err){
        statusEl.textContent = '❌ Errore: ' + err.message;
      } finally {
        btnSend.disabled = false;
      }
    }

    btnSend.addEventListener('click', send);

    btnCopy.addEventListener('click', () => {
      if (!out.textContent) return;
      navigator.clipboard.writeText(out.textContent);
      statusEl.textContent = '📋 Copiato negli appunti';
    });

    // Scorciatoie tastiera
    document.addEventListener('keydown', (e) => {
      if (e.key.toLowerCase() === 'a') setMode('breve');
      if (e.key.toLowerCase() === 'b') setMode('standard');
      if (e.key.toLowerCase() === 'c') setMode('dettagliata');
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') send();
    });
  </script>
</body>
</html>
