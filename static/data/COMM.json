@app.post("/api/ask", response_model=AnswerResponse)
async def api_ask(req: QuestionRequest):
    question_raw = (req.question or "").strip()
    if not question_raw:
        raise HTTPException(status_code=400, detail="Domanda vuota")

    q_norm = question_raw.lower()

    try:
        # 1) DOMANDE AZIENDALI / COMMERCIALI → SOLO COMM.JSON
        if is_commercial_question(q_norm):
            comm_block = match_comm(q_norm)
            if comm_block:
                answer = comm_block.get("response_variants", {}).get("gold", {}).get("it")
                if not answer:
                    answer = comm_block.get("answer_it") or comm_block.get("answer", "")
                return AnswerResponse(
                    answer=answer,
                    source="json_comm",
                    meta={"comm_id": comm_block.get("id")},
                )
            else:
                fallback = (
                    "Le informazioni richieste rientrano nei dati aziendali/commerciali. "
                    "Per sicurezza è necessario fare riferimento ai canali ufficiali Tecnaria."
                )
                return AnswerResponse(
                    answer=fallback,
                    source="json_comm_fallback",
                    meta={},
                )

        # 2) DOMANDE TECNICHE → CHATGPT GOLD TECNARIA
        gpt_answer = call_openai(SYSTEM_PROMPT_GOLD, question_raw, temperature=0.2)
        kb_block = match_from_kb(question_raw)
        kb_id = kb_block.get("id") if kb_block else None

        return AnswerResponse(
            answer=gpt_answer,
            source="chatgpt_gold_tecnaria",
            meta={
                "used_chatgpt": True,
                "kb_id": kb_id,
            },
        )
