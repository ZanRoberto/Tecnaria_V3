<script>
  const BASE = location.origin; // dominio attuale

  function setQ(t) {
    document.getElementById('question').value = t;
    sendQuestion();
  }

  async function ping() {
    const s = document.getElementById('status');
    const e = document.getElementById('err');
    e.style.display = 'none';
    s.textContent = 'ping...';
    try {
      const r = await fetch(BASE + '/api/config');
      const j = await r.json();
      s.textContent = `online · ${j.app}`;
    } catch (err) {
      s.textContent = 'errore ping';
      e.textContent = err;
      e.style.display = 'block';
    }
  }

  async function sendQuestion() {
    const q = document.getElementById('question').value.trim();
    const out = document.getElementById('answer');
    const s = document.getElementById('status');
    const e = document.getElementById('err');
    const meta = document.getElementById('meta');
    const src = document.getElementById('src');
    const match = document.getElementById('match');

    if (!q) {
      out.textContent = 'Scrivi una domanda prima.';
      return;
    }

    e.style.display = 'none';
    s.textContent = 'Sto chiedendo a Sinapsi…';

    try {
      const res = await fetch(BASE + '/api/ask', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          q: q,
          family: inferFamilyFromText(q) // deduce la famiglia dalla domanda
        })
      });

      if (!res.ok) {
        const txt = await res.text();
        out.textContent = 'Errore risposta backend.';
        e.textContent = txt;
        e.style.display = 'block';
        s.textContent = 'errore';
        meta.style.display = 'none';
        return;
      }

      const data = await res.json();
      out.textContent = data.text || 'Nessuna risposta.';
      src.textContent = data.id || '—';
      match.textContent = data.mode || '—';
      meta.style.display = 'flex';
      s.textContent = 'ok';
    } catch (err) {
      out.textContent = 'Errore di rete.';
      e.textContent = err;
      e.style.display = 'block';
      s.textContent = 'errore';
      meta.style.display = 'none';
    }
  }

  // piccola funzione per capire la famiglia dal testo (grezza ma utile)
  function inferFamilyFromText(q) {
    q = q.toLowerCase();
    if (q.includes("vct") || q.includes("vcem")) return "VCEM";
    if (q.includes("ctf")) return "CTF";
    if (q.includes("ctcem")) return "CTCEM";
    if (q.includes("ctl maxi")) return "CTL_MAXI";
    if (q.includes("ctl")) return "CTL";
    if (q.includes("p560")) return "P560";
    if (q.includes("diapason")) return "DIAPASON";
    return "COMM"; // fallback
  }

  ping();
</script>
