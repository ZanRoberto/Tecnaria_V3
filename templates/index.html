<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>TecnariaBot</title>
  <link rel="stylesheet" href="/static/img/style.css?v=3">
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f9; margin: 0; padding: 0; }
    header { background: #003366; color: white; padding: 1rem; display: flex; align-items: center; }
    header img { height: 50px; margin-right: 1rem; }
    h1 { margin: 0; font-size: 1.5rem; }
    .container { max-width: 900px; margin: 2rem auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
    label { font-weight: bold; }
    textarea { width: 100%; height: 100px; margin-top: .5rem; padding: .5rem; font-size: 1rem; }
    button { margin: .3rem; padding: .6rem 1.2rem; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .btnA { background: #0066cc; color: white; }
    .btnB { background: #ff6600; color: white; }
    .btnC { background: #009933; color: white; }
    .response { margin-top: 1.5rem; padding: 1rem; border: 1px solid #ddd; border-radius: 5px; background: #fafafa; }
    .attachments { margin-top: 1rem; }
    .attachments a { display: block; margin: .3rem 0; color: #0066cc; text-decoration: underline; }
    .loading { margin-top: 1rem; font-style: italic; color: #666; }
    .field-grid { display: grid; grid-template-columns: 1fr 1fr; gap: .6rem 1rem; margin-top: .5rem; }
    .field-grid label { display: block; font-size: .9rem; margin-bottom: .2rem; }
    .hint { font-size: .85rem; color: #555; margin-top: .5rem; }
  </style>
</head>
<body>
  <header>
    <img src="/static/img/logo.jpg" alt="Logo Tecnaria">
    <h1>TecnariaBot<br><small>Assistente Tecnico • Risposte A/B/C sempre coerenti</small></h1>
  </header>

  <div class="container">
    <label for="question">Domanda</label>
    <textarea id="question" placeholder="Scrivi la tua domanda..."></textarea>

    <div>
      <button class="btnA" onclick="setMode('breve')">A Breve</button>
      <button class="btnB" onclick="setMode('standard')">B Standard</button>
      <button class="btnC" onclick="setMode('dettagliata')">C Dettagliata</button>
    </div>

    <div id="wizard-container" style="display:none; margin-top:1rem;"></div>

    <label for="context">Dati tecnici richiesti (se la domanda è di calcolo)</label>
    <textarea id="context" placeholder="Se necessario verrà compilato dal mini-wizard…"></textarea>

    <button onclick="sendQuestion()">Invia</button>

    <div id="loading" class="loading" style="display:none;">⌛ Elaborazione in corso...</div>

    <div id="response" class="response"></div>
    <div id="attachments" class="attachments"></div>
  </div>

  <script src="/static/img/wizard.js?v=kt3"></script>
  <script>
    let currentMode = "dettagliata";

    function setMode(m) {
      currentMode = m;
      document.querySelectorAll("button").forEach(btn => btn.style.opacity="1");
      if(m==="breve") document.querySelector(".btnA").style.opacity="0.7";
      if(m==="standard") document.querySelector(".btnB").style.opacity="0.7";
      if(m==="dettagliata") document.querySelector(".btnC").style.opacity="0.7";
    }

    async function sendQuestion() {
      const q = document.getElementById("question").value;
      const ctx = document.getElementById("context").value;
      document.getElementById("loading").style.display="block";
      document.getElementById("response").innerHTML="";
      document.getElementById("attachments").innerHTML="";

      const res = await fetch("/api/answer", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({question:q, mode:currentMode, context:ctx})
      });
      const data = await res.json();
      document.getElementById("loading").style.display="none";

      if(data.answer){
        // Render HTML, non plain text
        document.getElementById("response").innerHTML = data.answer;
      }
      if(data.attachments){
        let html = "<h4>Allegati / Note collegate</h4>";
        data.attachments.forEach(a=>{
          html += `<a href="${a.href}" target="_blank">${a.label}</a>`;
        });
        document.getElementById("attachments").innerHTML = html;
      }
      // wizard se servono dati
      if(data.meta && data.meta.needs_params){
        const wiz = document.getElementById("wizard-container");
        wiz.style.display="block";
        buildWizard(wiz);
      }
    }
  </script>
</body>
</html>
