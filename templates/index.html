<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Tecnaria QA Bot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#0b1220; color:#e7eaf3; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 16px; font-size: 22px; font-weight: 700; }
    .card { background:#121a2b; border:1px solid #1e2a44; border-radius: 14px; padding: 16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    textarea { width:100%; min-height:120px; resize:vertical; padding:12px; border-radius:10px; border:1px solid #1e2a44; background:#0f1626; color:#fff; }
    .btn { background:#2b5cff; color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn.secondary { background:#1f2a45; color:#cdd6f4; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .tags { display:flex; gap:8px; flex-wrap:wrap; }
    .tag { background:#192543; border:1px solid #2a3a63; color:#cdd6f4; padding:6px 10px; border-radius:999px; cursor:pointer; }
    .answer { white-space:pre-wrap; background:#0f1626; border:1px solid #1e2a44; border-radius:10px; padding:12px; min-height:140px; }
    .muted { color:#99a6c4; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Tecnaria QA Bot</h1>

    <div class="card" style="margin-bottom:16px">
      <div class="tags">
        <span class="tag" data-q="Devo usare la chiodatrice P560 per fissare i CTF. Serve un patentino o formazione speciale?">P560 + CTF</span>
        <span class="tag" data-q="Che differenza c’è tra un connettore CTF e il sistema Diapason?">CTF vs Diapason</span>
        <span class="tag" data-q="Qual è la densità consigliata di connettori CTF per metro quadrato?">Densità CTF</span>
        <span class="tag" data-q="contatti">Contatti</span>
      </div>
    </div>

    <div class="card" style="margin-bottom:16px">
      <textarea id="q" placeholder="Scrivi qui la tua domanda…"></textarea>
      <div class="row" style="margin-top:12px">
        <button id="btnAsk" class="btn">Chiedi</button>
        <button id="btnClear" class="btn secondary">Pulisci</button>
        <button id="btnCopy" class="btn secondary">Copia risposta</button>
        <span id="status" class="muted"></span>
      </div>
      <div class="row" style="margin-top:8px">
        <label class="muted"><input type="checkbox" id="useGet" /> usa GET (debug)</label>
      </div>
    </div>

    <div class="card">
      <div id="answer" class="answer">La risposta apparirà qui…</div>
      <div style="margin-top:8px" class="muted">Endpoint: <code>/ask</code> (POST JSON { q } oppure GET ?q=…)</div>
    </div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const qEl = $("#q");
    const ansEl = $("#answer");
    const statusEl = $("#status");
    const useGet = $("#useGet");

    document.querySelectorAll(".tag").forEach(t => {
      t.addEventListener("click", () => { qEl.value = t.dataset.q || ""; qEl.focus(); });
    });

    $("#btnCopy").addEventListener("click", async () => {
      try { await navigator.clipboard.writeText(ansEl.textContent || ""); flash("Risposta copiata"); }
      catch { flash("Copia non disponibile"); }
    });

    $("#btnClear").addEventListener("click", () => {
      qEl.value = ""; ansEl.textContent = "La risposta apparirà qui…"; flash("");
    });

    qEl.addEventListener("keydown", e => { if ((e.ctrlKey || e.metaKey) && e.key === "Enter") send(); });
    $("#btnAsk").addEventListener("click", send);

    async function send() {
      const domanda = (qEl.value || "").trim();
      if (!domanda) { ansEl.textContent = "OK\n- **Domanda vuota**: inserisci una richiesta valida."; return; }
      $("#btnAsk").disabled = true; flash("Invio in corso…");
      try {
        let res;
        if (useGet.checked) {
          res = await fetch("/ask?q=" + encodeURIComponent(domanda), { method: "GET" });
        } else {
          res = await fetch("/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ q: domanda })   // <<<<<< CHIAVE GIUSTA
          });
        }
        const data = await res.json().catch(() => ({}));
        ansEl.textContent = (data && data.answer) ? data.answer : "Errore di risposta";
        flash("");
      } catch (e) {
        ansEl.textContent = "Errore di rete: " + (e?.message || e);
        flash("errore");
      } finally {
        $("#btnAsk").disabled = false;
      }
    }
    function flash(msg){ statusEl.textContent = msg || ""; }
  </script>
</body>
</html>
