<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TecnariaBot – Assistente Tecnico</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:32px;background:#0f172a;color:#e5e7eb}
    .card{max-width:900px;margin:0 auto;background:#111827;border:1px solid #1f2937;border-radius:14px;padding:24px}
    h1{font-size:20px;margin:0 0 8px} .muted{color:#9ca3af}
    textarea{width:100%;min-height:120px;padding:12px;border-radius:10px;border:1px solid #374151;background:#0b1220;color:#e5e7eb}
    button{padding:10px 16px;border:0;border-radius:10px;background:#f97316;color:#111827;font-weight:600;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:12px;align-items:center;margin-top:12px}
    .spinner{display:none;margin-left:8px;border:3px solid #334155;border-top:3px solid #f97316;border-radius:50%;width:18px;height:18px;animation:spin 1s linear infinite}
    @keyframes spin {100%{transform:rotate(360deg)}}
    .answer{white-space:pre-wrap;background:#0b1220;border:1px solid #223047;border-radius:10px;padding:12px;margin-top:16px}
    .atts a{display:inline-block;margin-right:10px;margin-top:8px;color:#93c5fd}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center}
    .modal-inner{background:#0b1220;border:1px solid #223047;border-radius:12px;max-width:90vw;max-height:90vh;padding:10px;position:relative}
    .modal-close{position:absolute;top:8px;right:10px;background:#ef4444;color:#fff;border:0;border-radius:8px;padding:6px 10px;cursor:pointer}
    .modal iframe,.modal img{max-width:85vw;max-height:80vh;border:0;border-radius:6px}
  </style>
</head>
<body>
  <div class="card">
    <h1>TecnariaBot</h1>
    <div class="muted">Assistente tecnico (solo prodotti Tecnaria)</div>

    <label for="q" style="display:block;margin-top:16px">Domanda</label>
    <textarea id="q" placeholder="Es: Posso usare una chiodatrice qualsiasi per CTF?"></textarea>

    <div class="row">
      <button id="send">Invia</button>
      <div class="spinner" id="spin"></div>
    </div>

    <div id="answer" class="answer" style="display:none"></div>
    <div id="atts" class="atts"></div>
  </div>

  <div class="modal" id="modal">
    <div class="modal-inner">
      <button class="modal-close" id="modalClose">✕</button>
      <div id="modalBody"></div>
    </div>
  </div>

<script>
const elQ = document.getElementById('q');
const elSend = document.getElementById('send');
const elSpin = document.getElementById('spin');
const elAns = document.getElementById('answer');
const elAtts = document.getElementById('atts');

function showSpinner(s){ elSpin.style.display = s ? 'inline-block' : 'none'; }
function setAnswer(t){ elAns.style.display='block'; elAns.textContent = t; }

async function ask(){
  const q = elQ.value.trim();
  if(!q){ setAnswer("Scrivi una domanda."); return; }
  showSpinner(true); elAns.style.display='none'; elAtts.innerHTML='';
  try{
    const r = await fetch('/api/answer', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({question:q}) });
    const j = await r.json();
    setAnswer(j.answer || "Nessuna risposta.");
    if(Array.isArray(j.attachments)){
      j.attachments.forEach(a=>{
        const link = document.createElement('a');
        link.href = a.href; link.textContent = a.label || a.href; link.target = "_blank";
        link.addEventListener('click', (ev)=>{
          ev.preventDefault();
          openModal(a);
        });
        elAtts.appendChild(link);
      });
    }
  }catch(e){
    setAnswer("Errore di rete. Riprova tra poco.");
  }finally{
    showSpinner(false);
  }
}

elSend.addEventListener('click', ask);
elQ.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && (e.ctrlKey || e.metaKey)) ask(); });

// --- Modale con X per tornare al bot ---
const modal = document.getElementById('modal');
const modalBody = document.getElementById('modalBody');
const modalClose = document.getElementById('modalClose');
function openModal(att){
  modal.style.display='flex';
  modalBody.innerHTML='';
  if(att.type==='image'){
    const img = document.createElement('img'); img.src = att.href; modalBody.appendChild(img);
  }else{
    const ifr = document.createElement('iframe'); ifr.src = att.href; ifr.width="960"; ifr.height="600"; modalBody.appendChild(ifr);
  }
}
modalClose.onclick = ()=>{ modal.style.display='none'; modalBody.innerHTML=''; };
modal.onclick = (e)=>{ if(e.target===modal){ modal.style.display='none'; modalBody.innerHTML=''; } };
</script>
</body>
</html>
