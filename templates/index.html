<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tecnaria · Assistente documentale</title>
  <style>
    :root{
      --bg:#0b1b2b; --card:#0f2640; --muted:#7fa5c9; --text:#eaf2fb; --accent:#4da3ff; --accent-2:#9ed0ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
         background:linear-gradient(160deg,#081523 0%, #0b1b2b 40%, #0a1f35 100%); color:var(--text)}
    .wrap{max-width:900px;margin:40px auto;padding:24px}
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .brand h1{font-size:18px;margin:0;font-weight:600;letter-spacing:.2px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.07);border-radius:14px;box-shadow:0 6px 30px rgba(0,0,0,.25)}
    .head{padding:18px 20px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;align-items:center}
    .status{font-size:12px;color:var(--muted)}
    .content{padding:18px 20px}
    .inputrow{display:flex;gap:10px}
    .inputrow input{flex:1;padding:14px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.12);
      background:#0b2138;color:var(--text);outline:none}
    .inputrow button{padding:14px 18px;border-radius:10px;border:0;background:var(--accent);color:#00162a;font-weight:700;cursor:pointer}
    .inputrow button:disabled{opacity:.6;cursor:not-allowed}
    .hint{margin-top:10px;color:var(--muted);font-size:12px}
    .answer{white-space:pre-wrap;line-height:1.45}
    .debug{margin-top:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size:12px;background:#061423;border:1px solid rgba(255,255,255,.09);border-radius:10px;padding:12px;color:#a6c3e5}
    .badge{background:rgba(77,163,255,.18);color:var(--accent-2);padding:4px 8px;border-radius:999px;font-size:12px}
    .btn{background:transparent;border:1px solid rgba(255,255,255,.18);color:var(--text);padding:8px 10px;border-radius:8px;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <div class="badge">Tecnaria · Assistente documentale</div>
      <div id="healthDot" class="status">verifica indice…</div>
    </div>

    <div class="card">
      <div class="head">
        <div>Fai una domanda sui prodotti o sulla documentazione</div>
        <div>
          <button id="btnReload" class="btn" title="Ricarica indice" style="display:none">Ricarica indice</button>
        </div>
      </div>
      <div class="content">
        <form id="askForm" class="inputrow">
          <!-- NOME CAMPO GIUSTO: 'domanda' -->
          <input id="domanda" name="domanda" type="text" placeholder="Es: mi parli della P560? / mi dai i contatti? / codici connettori" autocomplete="off" />
          <button id="btnAsk" type="submit">Chiedi</button>
        </form>
        <div class="hint">Suggerimenti: “mi parli della P560?”, “contatti Tecnaria”, “codici connettori”, “chi è Tecnaria?”.</div>

        <div id="out" class="answer" style="margin-top:16px"></div>
        <div id="dbg" class="debug" style="display:none"></div>
      </div>
    </div>
  </div>

  <script>
    const elQ   = document.getElementById('domanda');
    const elOut = document.getElementById('out');
    const elDbg = document.getElementById('dbg');
    const elDot = document.getElementById('healthDot');
    const elReload = document.getElementById('btnReload');
    const btnAsk = document.getElementById('btnAsk');
    let indexReady = false;

    async function health(init=false){
      try{
        const r = await fetch('/health');
        const j = await r.json();
        indexReady = (j.docs && j.docs > 0);
        elDot.textContent = indexReady ? `indice pronto · ${j.docs} blocchi` : 'indice non pronto';
        elReload.style.display = indexReady ? 'inline-block' : 'inline-block';
        if(!indexReady && init){
          // prova un auto-reload una volta
          await reloadIndex();
          // ri-verifica
          const r2 = await fetch('/health');
          const j2 = await r2.json();
          indexReady = (j2.docs && j2.docs > 0);
          elDot.textContent = indexReady ? `indice pronto · ${j2.docs} blocchi` : 'indice non pronto';
        }
      }catch(e){
        elDot.textContent = 'errore health';
      }
    }

    async function reloadIndex(){
      try{
        elReload.disabled = true;
        const r = await fetch('/reload', {method:'POST'});
        const j = await r.json();
        elOut.textContent = `Indice ricaricato: ${j.docs ?? '0'} documenti.`;
      }catch(e){
        elOut.textContent = 'Errore nella ricarica indice.';
      }finally{
        elReload.disabled = false;
      }
    }

    elReload.addEventListener('click', async (ev)=>{
      ev.preventDefault();
      await reloadIndex();
      await health(false);
    });

    document.getElementById('askForm').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const q = elQ.value.trim();
      if(!q){
        elOut.textContent = 'Scrivi una domanda…';
        return;
      }
      btnAsk.disabled = true;
      elOut.textContent = '⏳ Sto cercando…';
      elDbg.style.display = 'none';

      try{
        // INVIA FORM-DATA con CAMPO 'domanda'
        const fd = new FormData();
        fd.append('domanda', q);
        const r = await fetch('/ask', {method:'POST', body: fd});
        const j = await r.json();

        // risposta
        elOut.textContent = j.answer || '(nessuna risposta)';
        // debug (se disponibile)
        const dbg = {
          found: j.found, score: j.score, from: j.from, tags: j.tags, question: j.question
        };
        elDbg.textContent = JSON.stringify(dbg, null, 2);
        elDbg.style.display = 'block';
      }catch(e){
        elOut.textContent = 'Errore di rete o server.';
      }finally{
        btnAsk.disabled = false;
      }
    });

    // all'avvio: controlla health e – se vuoto – prova un reload
    health(true);

    // placeholder utile
    elQ.value = '';
    elQ.focus();
  </script>
</body>
</html>
